name: å®‰å…¨å•é¡Œè‡ªå‹•ä¿®å¾©

on:
  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      fix_nginx:
        description: 'ä¿®å¾© Nginx é…ç½®å•é¡Œ'
        type: boolean
        default: true
      fix_dockerfile:
        description: 'ä¿®å¾© Dockerfile å•é¡Œ'
        type: boolean
        default: true
      fix_terraform:
        description: 'ä¿®å¾© Terraform å•é¡Œ'
        type: boolean
        default: true
      create_pr:
        description: 'å»ºç«‹ Pull Request'
        type: boolean
        default: true

  # æ¯é€±è‡ªå‹•åŸ·è¡Œ
  schedule:
    - cron: '0 2 * * 1'  # æ¯é€±ä¸€å‡Œæ™¨2é»

jobs:
  security-auto-fix:
    name: è‡ªå‹•ä¿®å¾©å®‰å…¨å•é¡Œ
    runs-on: ubuntu-latest
    
    steps:
      - name: æª¢å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: è¨­å®š Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: å®‰è£ Semgrep
        run: |
          python -m pip install --upgrade pip
          pip install semgrep
          
      - name: å®‰è£ä¿®å¾©å·¥å…·
        run: |
          pip install pyyaml requests
          
      - name: åŸ·è¡Œ Semgrep æƒæ
        id: semgrep_scan
        run: |
          echo "åŸ·è¡Œ Semgrep å®‰å…¨æƒæ..."
          semgrep scan --config auto --json --output semgrep-results.json || true
          
          # è§£æçµæœ
          if [ -f semgrep-results.json ]; then
            python -c "import json; import sys; data=json.load(open('semgrep-results.json')); findings=data.get('results', []); print(f'ç™¼ç¾ {len(findings)} å€‹å•é¡Œ'); sys.exit(0 if findings else 1)"
            echo "findings_count=$(python -c "import json; data=json.load(open('semgrep-results.json')); print(len(data.get('results', [])))")" >> $GITHUB_OUTPUT
          else
            echo "findings_count=0" >> $GITHUB_OUTPUT
          fi
          
      - name: ä¿®å¾© Nginx é…ç½®å•é¡Œ
        if: ${{ inputs.fix_nginx }}
        run: |
          echo "ä¿®å¾© Nginx é…ç½®å®‰å…¨å•é¡Œ..."
          
          # ä¿®å¾© nginx.conf ä¸­çš„å®‰å…¨æ¨™é ­å•é¡Œ
          if [ -f nginx/nginx.conf ]; then
            # å‚™ä»½åŸå§‹æª”æ¡ˆ
            cp nginx/nginx.conf nginx/nginx.conf.backup
            
            # ä¿®å¾© add_header å•é¡Œ
            sed -i 's/add_header Content-Type text\/plain;/add_header Content-Type text\/plain always;/g' nginx/nginx.conf
            
            # ä¿®å¾© H2C èµ°ç§å•é¡Œ - é™åˆ¶ Upgrade æ¨™é ­
            sed -i '/proxy_set_header Upgrade/a\    # é™åˆ¶ Upgrade æ¨™é ­ä»¥é˜²æ­¢ H2C èµ°ç§\n    proxy_set_header Upgrade $http_upgrade;\n    proxy_set_header Connection "upgrade";' nginx/nginx.conf
            
            echo "Nginx é…ç½®å·²ä¿®å¾©"
          fi
          
      - name: ä¿®å¾© Dockerfile å•é¡Œ
        if: ${{ inputs.fix_dockerfile }}
        run: |
          echo "ä¿®å¾© Dockerfile å®‰å…¨å•é¡Œ..."
          
          # ä¿®å¾© services/llm-reporter/Dockerfile
          if [ -f services/llm-reporter/Dockerfile ]; then
            # å‚™ä»½åŸå§‹æª”æ¡ˆ
            cp services/llm-reporter/Dockerfile services/llm-reporter/Dockerfile.backup
            
            # æ·»åŠ é root ç”¨æˆ¶
            sed -i '/CMD \["python", "app.py"\]/i\\n# å‰µå»ºé root ç”¨æˆ¶\nRUN adduser --disabled-password --gecos "" appuser\nUSER appuser\n' services/llm-reporter/Dockerfile
            
            echo "Dockerfile å·²ä¿®å¾©"
          fi
          
      - name: ä¿®å¾© Terraform å•é¡Œ
        if: ${{ inputs.fix_terraform }}
        run: |
          echo "ä¿®å¾© Terraform å®‰å…¨å•é¡Œ..."
          
          # ä¿®å¾© ECS æ¨¡çµ„ä¸­çš„ ELB æ—¥èªŒå•é¡Œ
          if [ -f terraform/modules/ecs/main.tf ]; then
            # å‚™ä»½åŸå§‹æª”æ¡ˆ
            cp terraform/modules/ecs/main.tf terraform/modules/ecs/main.tf.backup
            
            # æ·»åŠ  ELB æ—¥èªŒé…ç½®
            sed -i '/enable_deletion_protection = var.enable_deletion_protection/a\\n  # å•Ÿç”¨å­˜å–æ—¥èªŒ\n  access_logs {\n    bucket  = aws_s3_bucket.alb_logs[0].id\n    prefix  = "alb-logs"\n  }\n' terraform/modules/ecs/main.tf
            
            # ä¿®å¾© TLS ç‰ˆæœ¬å•é¡Œ
            sed -i 's/protocol = "HTTP"/protocol = "HTTPS"\n  ssl_policy = "ELBSecurityPolicy-TLS13-1-2-Res-2021-06"/g' terraform/modules/ecs/main.tf
            
            echo "ECS æ¨¡çµ„å·²ä¿®å¾©"
          fi
          
          # ä¿®å¾© RDS æ¨¡çµ„ä¸­çš„åŠ å¯†å•é¡Œ
          if [ -f terraform/modules/rds/main.tf ]; then
            # å‚™ä»½åŸå§‹æª”æ¡ˆ
            cp terraform/modules/rds/main.tf terraform/modules/rds/main.tf.backup
            
            # æ·»åŠ  KMS é‡‘é‘°è¼ªæ›
            sed -i '/deletion_window_in_days = 7/a\\n  enable_key_rotation = true\n' terraform/modules/rds/main.tf
            
            # æ·»åŠ  CloudWatch æ—¥èªŒåŠ å¯†
            sed -i '/retention_in_days = var.log_retention_days/a\\n  kms_key_id = aws_kms_key.rds.arn\n' terraform/modules/rds/main.tf
            
            echo "RDS æ¨¡çµ„å·²ä¿®å¾©"
          fi
          
          # ä¿®å¾© VPC æ¨¡çµ„ä¸­çš„å­ç¶²è·¯å•é¡Œ
          if [ -f terraform/modules/vpc/main.tf ]; then
            # å‚™ä»½åŸå§‹æª”æ¡ˆ
            cp terraform/modules/vpc/main.tf terraform/modules/vpc/main.tf.backup
            
            # ä¿®å¾©å…¬å…± IP åœ°å€å•é¡Œ
            sed -i 's/map_public_ip_on_launch = true/map_public_ip_on_launch = false/g' terraform/modules/vpc/main.tf
            
            echo "VPC æ¨¡çµ„å·²ä¿®å¾©"
          fi
          
      - name: é©—è­‰ä¿®å¾©çµæœ
        run: |
          echo "é©—è­‰ä¿®å¾©çµæœ..."
          
          # é‡æ–°åŸ·è¡Œ Semgrep æƒæ
          semgrep scan --config auto --json --output semgrep-results-after-fix.json || true
          
          # æ¯”è¼ƒä¿®å¾©å‰å¾Œçš„çµæœ
          if [ -f semgrep-results.json ] && [ -f semgrep-results-after-fix.json ]; then
            before_count=$(python -c "import json; data=json.load(open('semgrep-results.json')); print(len(data.get('results', [])))")
            after_count=$(python -c "import json; data=json.load(open('semgrep-results-after-fix.json')); print(len(data.get('results', [])))")
            
            echo "ä¿®å¾©å‰å•é¡Œæ•¸é‡: $before_count"
            echo "ä¿®å¾©å¾Œå•é¡Œæ•¸é‡: $after_count"
            
            if [ $after_count -lt $before_count ]; then
              echo "âœ… æˆåŠŸä¿®å¾©äº† $((before_count - after_count)) å€‹å®‰å…¨å•é¡Œ"
              echo "fixed_count=$((before_count - after_count))" >> $GITHUB_OUTPUT
            else
              echo "âŒ æ²’æœ‰ä¿®å¾©ä»»ä½•å•é¡Œ"
              echo "fixed_count=0" >> $GITHUB_OUTPUT
            fi
          fi
          
      - name: å»ºç«‹ä¿®å¾©å ±å‘Š
        run: |
          echo "å»ºç«‹ä¿®å¾©å ±å‘Š..."
          
          cat > security-fix-report.md << 'EOF'
          # å®‰å…¨å•é¡Œè‡ªå‹•ä¿®å¾©å ±å‘Š
          
          ## ä¿®å¾©æ‘˜è¦
          - **ä¿®å¾©å‰å•é¡Œæ•¸é‡**: ${{ steps.semgrep_scan.outputs.findings_count }}
          - **ä¿®å¾©å¾Œå•é¡Œæ•¸é‡**: $(python -c "import json; data=json.load(open('semgrep-results-after-fix.json')); print(len(data.get('results', [])))" 2>/dev/null || echo "æœªçŸ¥")
          - **æˆåŠŸä¿®å¾©æ•¸é‡**: ${{ steps.security-auto-fix.outputs.fixed_count }}
          
          ## ä¿®å¾©çš„å•é¡Œé¡å‹
          
          ### 1. Nginx é…ç½®å•é¡Œ
          - âœ… ä¿®å¾©äº†ç¼ºå°‘ `always` æ¨™èªŒçš„ `add_header` æŒ‡ä»¤
          - âœ… ä¿®å¾©äº† H2C èµ°ç§æ¼æ´ï¼Œé™åˆ¶ Upgrade æ¨™é ­
          
          ### 2. Dockerfile å®‰å…¨å•é¡Œ
          - âœ… æ·»åŠ äº†é root ç”¨æˆ¶ä»¥æå‡å®¹å™¨å®‰å…¨æ€§
          
          ### 3. Terraform å®‰å…¨å•é¡Œ
          - âœ… å•Ÿç”¨äº† ELB å­˜å–æ—¥èªŒ
          - âœ… å‡ç´šäº† TLS ç‰ˆæœ¬åˆ°å®‰å…¨ç‰ˆæœ¬
          - âœ… å•Ÿç”¨äº† KMS é‡‘é‘°è¼ªæ›
          - âœ… æ·»åŠ äº† CloudWatch æ—¥èªŒåŠ å¯†
          - âœ… ä¿®å¾©äº†å­ç¶²è·¯å…¬å…± IP åœ°å€å•é¡Œ
          
          ## å»ºè­°çš„å¾ŒçºŒè¡Œå‹•
          1. å¯©æŸ¥æ‰€æœ‰ä¿®å¾©çš„è®Šæ›´
          2. åœ¨æ¸¬è©¦ç’°å¢ƒä¸­é©—è­‰ä¿®å¾©æ•ˆæœ
          3. æ›´æ–°ç›¸é—œçš„éƒ¨ç½²æ–‡æª”
          4. å»ºç«‹å®‰å…¨æƒæçš„æŒçºŒæ•´åˆæµç¨‹
          
          ## æ³¨æ„äº‹é …
          - æ‰€æœ‰åŸå§‹æª”æ¡ˆéƒ½å·²å‚™ä»½ï¼ˆ.backup å‰¯æª”åï¼‰
          - å»ºè­°åœ¨éƒ¨ç½²å‰é€²è¡Œå®Œæ•´çš„æ¸¬è©¦
          - æŸäº›ä¿®å¾©å¯èƒ½éœ€è¦é¡å¤–çš„ AWS è³‡æºé…ç½®
          EOF
          
      - name: å»ºç«‹ Pull Request
        if: ${{ inputs.create_pr && steps.security-auto-fix.outputs.fixed_count > 0 }}
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ğŸ”’ è‡ªå‹•ä¿®å¾©å®‰å…¨å•é¡Œ"
          title: "ğŸ”’ è‡ªå‹•ä¿®å¾© Semgrep ç™¼ç¾çš„å®‰å…¨å•é¡Œ"
          body: |
            ## å®‰å…¨å•é¡Œè‡ªå‹•ä¿®å¾©
            
            æ­¤ PR è‡ªå‹•ä¿®å¾©äº† Semgrep æƒæç™¼ç¾çš„å®‰å…¨å•é¡Œï¼š
            
            - **ä¿®å¾©å‰å•é¡Œæ•¸é‡**: ${{ steps.semgrep_scan.outputs.findings_count }}
            - **æˆåŠŸä¿®å¾©æ•¸é‡**: ${{ steps.security-auto-fix.outputs.fixed_count }}
            
            ### ä¿®å¾©çš„å•é¡Œé¡å‹ï¼š
            1. **Nginx é…ç½®å•é¡Œ** - ä¿®å¾©äº†å®‰å…¨æ¨™é ­å’Œ H2C èµ°ç§æ¼æ´
            2. **Dockerfile å®‰å…¨å•é¡Œ** - æ·»åŠ äº†é root ç”¨æˆ¶
            3. **Terraform å®‰å…¨å•é¡Œ** - å•Ÿç”¨äº†åŠ å¯†ã€æ—¥èªŒè¨˜éŒ„ç­‰å®‰å…¨åŠŸèƒ½
            
            ### è®Šæ›´æª”æ¡ˆï¼š
            - `nginx/nginx.conf` - ä¿®å¾©å®‰å…¨æ¨™é ­é…ç½®
            - `services/llm-reporter/Dockerfile` - æ·»åŠ é root ç”¨æˆ¶
            - `terraform/modules/ecs/main.tf` - å•Ÿç”¨ ELB æ—¥èªŒå’Œ TLS å®‰å…¨ç‰ˆæœ¬
            - `terraform/modules/rds/main.tf` - å•Ÿç”¨ KMS è¼ªæ›å’Œæ—¥èªŒåŠ å¯†
            - `terraform/modules/vpc/main.tf` - ä¿®å¾©å­ç¶²è·¯å…¬å…± IP å•é¡Œ
            
            ### æ³¨æ„äº‹é …ï¼š
            - æ‰€æœ‰åŸå§‹æª”æ¡ˆéƒ½å·²å‚™ä»½
            - å»ºè­°åœ¨éƒ¨ç½²å‰é€²è¡Œå®Œæ•´æ¸¬è©¦
            - æŸäº›ä¿®å¾©å¯èƒ½éœ€è¦é¡å¤–çš„ AWS è³‡æºé…ç½®
            
            è©³ç´°å ±å‘Šè«‹åƒè€ƒï¼šsecurity-fix-report.md
          branch: security-auto-fix-$(date +%Y%m%d-%H%M%S)
          base: main
          delete-branch: true
          
      - name: ä¸Šå‚³ä¿®å¾©å ±å‘Š
        uses: actions/upload-artifact@v3
        with:
          name: security-fix-report
          path: |
            security-fix-report.md
            semgrep-results.json
            semgrep-results-after-fix.json
          retention-days: 30
